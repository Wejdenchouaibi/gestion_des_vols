<div class="container mt-5">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <img src="assets/logo Tunisair.png" alt="Tunisair" style="height: 50px" />
    <div>
      <span *ngIf="user" class="me-3">Bienvenue, {{ user.firstName }} {{ user.lastName }}</span>
      <button class="btn btn-outline-primary" (click)="user ? logout() : login()">
        {{ user ? 'Déconnexion' : 'Connexion' }}
      </button>
    </div>
  </div>

  <!-- List View if no ID -->
  <section class="list-section" *ngIf="!reservation">
    <h3>Mes Réservations</h3>
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>ID Réservation</th>
          <th>Vol</th>
          <th>Passagers</th>
          <th>Classe</th>
          <th>Total</th>
          <th>Statut</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let res of reservations">
          <td>{{ res._id }}</td>
          <td>{{ res.flight_id }}</td>
          <td>{{ res.passengers }}</td>
          <td>{{ res.class }}</td>
          <td>{{ res.total_price | currency:'EUR':'symbol':'1.0-0' }}</td>
          <td>{{ res.status }}</td>
          <td>
            <button class="btn btn-sm btn-primary" (click)="viewReservation(res._id)">Gérer Passagers</button>
          </td>
        </tr>
        <tr *ngIf="reservations.length === 0">
          <td colspan="7" class="text-center">Aucune réservation trouvée.</td>
        </tr>
      </tbody>
    </table>
  </section>

  <!-- Single View if ID provided -->
  <section class="reservation-section" *ngIf="reservation && flight">
    <h3>Gérer les Passagers de la Réservation</h3>
    <div class="card mb-3">
      <div class="card-body">
        <h5>Détails du Vol</h5>
        <p>
          ✈️ {{ flight.departure }} → {{ flight.arrival }}
          le {{ flight.schedule | date: 'dd/MM/yyyy' }}
          (Prix: {{ flight.price }} | Classe: {{ reservation.class }} |
          Compagnie: {{ flight.company }} | Durée: {{ flight.duration }}h |
          Escales: {{ flight.escales }})
        </p>
        <p>Passagers: {{ reservation.passengers }} | Total: {{ reservation.total_price | currency:'EUR':'symbol':'1.0-0' }}</p>
      </div>
    </div>

    <!-- Passengers List -->
    <h4>Liste des Passagers</h4>
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>Nom</th>
          <th>Numéro de Passeport</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let passenger of reservation.passengers_details; let i = index">
          <td>{{ passenger.name }}</td>
          <td>{{ passenger.passport_number }}</td>
          <td>
            <button class="btn btn-sm btn-primary me-2" (click)="editPassenger(i)">Modifier</button>
            <button class="btn btn-sm btn-danger" (click)="deletePassenger(i)">Supprimer</button>
          </td>
        </tr>
        <tr *ngIf="!reservation.passengers_details || reservation.passengers_details.length === 0">
          <td colspan="3" class="text-center">Aucun passager ajouté.</td>
        </tr>
      </tbody>
    </table>

    <!-- Add/Edit Passenger Form -->
    <div class="card mb-3">
      <div class="card-body">
        <h5>{{ editingPassenger ? 'Modifier le Passager' : 'Ajouter un Passager' }}</h5>
        <form #passengerForm="ngForm" (ngSubmit)="editingPassenger ? updatePassenger() : addPassenger()">
          <div class="row">
            <div class="col-md-6">
              <label for="name">Nom complet :</label>
    <input type="text" id="name" name="name"
      [ngModel]="editingPassenger ? editingPassenger.name : newPassenger.name"
      (ngModelChange)="editingPassenger ? editingPassenger.name = $event : newPassenger.name = $event"
      class="form-control" required />
            </div>
            <div class="col-md-6">
              <label for="passport_number">Numéro de passeport :</label>
    <input type="text" id="passport_number" name="passport_number"
      [ngModel]="editingPassenger ? editingPassenger.passport_number : newPassenger.passport_number"
      (ngModelChange)="editingPassenger ? editingPassenger.passport_number = $event : newPassenger.passport_number = $event"
      class="form-control" required />
            </div>
          </div>
          <div class="mt-3">
            <button type="submit" class="btn btn-primary me-2">
              {{ editingPassenger ? 'Modifier' : 'Ajouter' }}
            </button>
            <button type="button" class="btn btn-secondary" *ngIf="editingPassenger" (click)="editingPassenger = null; editingIndex = null">
              Annuler
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Reservation Actions -->
    <div class="mt-3">
      <button class="btn btn-danger me-2" (click)="cancelReservation()">Annuler la Réservation</button>
      <button class="btn btn-secondary" (click)="user_dach()">Retour au Tableau de Bord</button>
    </div>
  </section>

  <!-- Navigation Links -->
  <div class="mt-4">
    <h4>Autres services :</h4>
    <a routerLink="/search-flight" class="btn btn-info me-2">Rechercher un Vol</a>
    <a routerLink="/booking" class="btn btn-info">Réserver un Vol</a>
  </div>
</div>